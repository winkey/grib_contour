#!/bin/bash

source $1

username='grib_contour'
group='software'
host='67.58.51.110'
pguser='atmos'
pgdb='NewWorld'

mypsql() {
    psql -h "$host" -U "$pguser" "$pgdb" $@
}

mkuid() {
    
    read sha junk <<< $(dd if=/dev/urandom count=20 bs=1 2> /dev/null | shasum )
    mypsql << EOF

insert into auth_user( 
    username,
    first_name,
    last_name,
    email,
    password,
    is_staff,
    is_active,
    is_superuser,
    last_login,
    date_joined
) VALUES (
    '$username',
    '',
    '',
    '',
    'sha1\$$sha',
    FALSE,
    FALSE,
    FALSE,
    now(),
    now()
);

EOF
}

mkgid() {

    mypsql << EOF

insert into auth_group( name) values ('$group');
EOF

}

addtogroup () {
    
mypsql << EOF
insert into from auth_user_groups (
    user_id,
    group_id 
) values ( $1, $2)
EOF
}

is_number() {
    number="$1"

    if [ $number  == $( bc <<< $number) ]
    then
        true
    else
        false
    fi

}

getuid() {
    mypsql -t -q << EOL
select id from auth_user where username='$username';
EOL

}

getgid() {
    mypsql -t -q << EOL
select id from auth_group where name='$group';
EOL
}


################################################################################
## function to add a folder
# @param layeraray
# @param owner_id    the owner id of this new node (CAN BE NULL)
# @param groups_id   the group id of this new node (CAN BE NULL)
# @param name        the name of the node to add
# @param tooltip
# @param metadata

################################################################################






add_layers_folder() {

    mypsql << EOL

select  layers_add_folder_by_name(array[$1], $2, $3, '$4', '$5', '$6');

EOL
}
################################################################################
## function to add a radio folder
# @param layeraray
# @param owner_id    the owner id of this new node (CAN BE NULL)
# @param groups_id   the group id of this new node (CAN BE NULL)
# @param name        the name of the node to add
# @param tooltip
# @param metadata

################################################################################

add_layers_radio() {

    mypsql << EOL

    select  layers_add_radio_by_name(array[$1], $2, $3, '$4', '$5', '$6');
    

EOL
}

################################################################################
## function to add a animation folder
# @param layeraray
# @param owner_id    the owner id of this new node (CAN BE NULL)
# @param groups_id   the group id of this new node (CAN BE NULL)
# @param name        the name of the node to add
# @param tooltip
# @param metadata

################################################################################

add_layers_animation() {

    mypsql << EOL

    select  layers_add_radio_by_animation(array[$1], $2, $3, '$4', '$5', '$6');
    

EOL
}

################################################################################
## main
################################################################################


##### get the uid and add the user if nessasary #####

NewWorld_uid=$(getuid)
if [ is_number $NewWorld_uid ]
then
    ;;
else
    mkuid
    NewWorld_uid=$(getuid)
fi

##### get the gid and add the group if nessasary #####

NewWorld_gid=$(getgid)
if [ is_number $NewWorld_gid ]
then
    ;;
else
    mkgid
    addtogroup  $NewWorld_uid $NewWorld_gid
fi


##### add the main folder fpor the product #####

add_layers_folder "'weather'" $NewWorld_uid $NewWorld_gid "$name" "$fullname" "$description"


##### add all the sub product folders #####

##### one level only #####

if [ -n "$levels" ]
then
    while read lev_n lev_fn
    do
        add_layers_folder "'weather', '$name'" $NewWorld_uid $NewWorld_gid "$lev_fn" "$lev_fn" ""

        ref="products$lev_n"
        while read prod_n prod_fn
        do
            add_layers_radio "'weather', '$name', '$lev_fn'" $NewWorld_uid $NewWorld_gid "$prod_fn" "$prod_fn" ""
            while read run_n run_fn
            do
                add_layers_animation "'weather', '$name', '$lev_fn', '$prod_fn'" $NewWorld_uid $NewWorld_gid "$run_fn" "$run_fn" ""
            
            done <<< "$run"
        done <<< "${!ref}"
    done  <<< "$levels"
fi

##### one level only #####

if [ -n "$levels2" ]
then
    while read lev_n lev_fn
    do
        add_layers_folder "'weather', '$name'" $NewWorld_uid $NewWorld_gid "$lev_fn" "$lev_fn" ""

        while read prod_n prod_fn
        do
            add_layers_radio "'weather', '$name', '$lev_fn'" $NewWorld_uid $NewWorld_gid "$prod_fn" "$prod_fn" ""
            while read run
            do
                add_layers_animation "'weather', '$name', '$lev_fn', '$prod_fn'" $NewWorld_uid $NewWorld_gid "$run" "$run" ""
            
            done <<< "$run"
        done <<< "$products2"
    done  <<< "$levels2"
fi

##### no level just products #####

if [ -n "$products" ]
then
    while read prod_n prod_fn
    do
        add_layers_radio "'weather', '$name'" $NewWorld_uid $NewWorld_gid "$prod_fn" "$prod_fn" ""
        while read run
        do
            add_layers_animation "'weather', '$name', '$prod_fn'" $NewWorld_uid $NewWorld_gid "$run" "$run" ""
        
        done <<< "$run"
    done <<< "$products"
fi



