#!/bin/bash

source ../scripts/NewWorld.bash
source ../share/configs.sh


#call me in a subshell

mknewworld_ds() {

    source $1

    add_layers_folder "'LayerTree', 'weather'" "$NewWorld_uid" "$NewWorld_gid" "$name" "$fullname" "$description"
     ##### add all the sub product folders #####

    ##### one level only #####

    if [ -n "$levels" ]
    then
        while read lev_n lev_fn
        do
            add_layers_folder "'LayerTree', 'weather', '$name'" "$NewWorld_uid" "$NewWorld_gid" "$lev_fn" "$lev_fn" ""

            ref="products$lev_n"
            while read prod_n prod_fn
            do
                add_layers_radio "'LayerTree', 'weather', '$name', '$lev_fn'" "$NewWorld_uid" "$NewWorld_gid" "$prod_fn" "$prod_fn" ""
                while read run_n run_fn
                do
                    add_layers_animation "'LayerTree', 'weather', '$name', '$lev_fn', '$prod_fn'" "$NewWorld_uid" "$NewWorld_gid" "$run_fn" "$run_fn" ""
                
                done <<< "$run"
            done <<< "${!ref}"
        done  <<< "$levels"
    fi

    ##### one level only #####

    if [ -n "$levels2" ]
    then
        while read lev_n lev_fn
        do
            add_layers_folder "'LayerTree', 'weather', '$name'" "$NewWorld_uid" "$NewWorld_gid" "$lev_fn" "$lev_fn" ""

            while read prod_n prod_fn
            do
                add_layers_radio "'LayerTree', 'weather', '$name', '$lev_fn'" "$NewWorld_uid" "$NewWorld_gid" "$prod_fn" "$prod_fn" ""
                while read run
                do
                    add_layers_animation "'LayerTree', 'weather', '$name', '$lev_fn', '$prod_fn'" "$NewWorld_uid" "$NewWorld_gid" "$run" "$run" ""
                
                done <<< "$run"
            done <<< "$products2"
        done  <<< "$levels2"
    fi

    ##### no level just products #####

    if [ -n "$products" ]
    then
        while read prod_n prod_fn
        do
            add_layers_radio "'LayerTree', 'weather', '$name'" "$NewWorld_uid" "$NewWorld_gid" "$prod_fn" "$prod_fn" ""
            while read run
            do
                add_layers_animation "'LayerTree', 'weather', '$name', '$prod_fn'" "$NewWorld_uid" "$NewWorld_gid" "$run" "$run" ""
            
            done <<< "$run"
        done <<< "$products"
    fi
}


################################################################################
## main
################################################################################


    ##### get the uid and add the user if nessasary #####

    NewWorld_uid=$(getuid | tr -d '[[:space:]]')
    echo "uid is $NewWorld_uid"
    if is_number "$NewWorld_uid"
    then
        echo
    else
        mkuid
        NewWorld_uid=$(getuid)
        NewWorld_uid=$(getuid | tr -d '[[:space:]]')
        echo "uid is $NewWorld_uid"
    fi

    ##### get the gid and add the group if nessasary #####

    NewWorld_gid=$(getgid | tr -d '[[:space:]]')
    echo "gid is $NewWorld_gid"
    if is_number "$NewWorld_gid"
    then
        echo
    else
        mkgid
        addtogroup  "$NewWorld_uid" $NewWorld_gid
        NewWorld_gid=$(getgid | tr -d '[[:space:]]')
        echo "gid is $NewWorld_gid"
    fi

    # fixme we should test if its made
    ##### add the main folder fpor the product #####

    add_layers_folder "'LayerTree'" "$NewWorld_uid" "$NewWorld_gid" "weather" "weather" "$description"


   
while read conf
do
    (mknewworld_ds "$conf")
done <<< "$configs"
