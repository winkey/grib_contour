#!/bin/bash

source ../scripts/NewWorld.bash
source ../share/configs.sh


#call me in a subshell

mknewworld_ds() {

    source $1


     ##### add all the sub product folders #####

    ##### one level only #####

    if [ -n "$levels" ]
    then
        while read lev_n lev_fn
        do
            add_layers_folder "'weather', '$name'" $NewWorld_uid $NewWorld_gid "$lev_fn" "$lev_fn" ""

            ref="products$lev_n"
            while read prod_n prod_fn
            do
                add_layers_radio "'weather', '$name', '$lev_fn'" $NewWorld_uid $NewWorld_gid "$prod_fn" "$prod_fn" ""
                while read run_n run_fn
                do
                    add_layers_animation "'weather', '$name', '$lev_fn', '$prod_fn'" $NewWorld_uid $NewWorld_gid "$run_fn" "$run_fn" ""
                
                done <<< "$run"
            done <<< "${!ref}"
        done  <<< "$levels"
    fi

    ##### one level only #####

    if [ -n "$levels2" ]
    then
        while read lev_n lev_fn
        do
            add_layers_folder "'weather', '$name'" $NewWorld_uid $NewWorld_gid "$lev_fn" "$lev_fn" ""

            while read prod_n prod_fn
            do
                add_layers_radio "'weather', '$name', '$lev_fn'" $NewWorld_uid $NewWorld_gid "$prod_fn" "$prod_fn" ""
                while read run
                do
                    add_layers_animation "'weather', '$name', '$lev_fn', '$prod_fn'" $NewWorld_uid $NewWorld_gid "$run" "$run" ""
                
                done <<< "$run"
            done <<< "$products2"
        done  <<< "$levels2"
    fi

    ##### no level just products #####

    if [ -n "$products" ]
    then
        while read prod_n prod_fn
        do
            add_layers_radio "'weather', '$name'" $NewWorld_uid $NewWorld_gid "$prod_fn" "$prod_fn" ""
            while read run
            do
                add_layers_animation "'weather', '$name', '$prod_fn'" $NewWorld_uid $NewWorld_gid "$run" "$run" ""
            
            done <<< "$run"
        done <<< "$products"
    fi
}


################################################################################
## main
################################################################################


    ##### get the uid and add the user if nessasary #####

    NewWorld_uid=$(getuid)
    if [ is_number $NewWorld_uid ]
    then
        ;;
    else
        mkuid
        NewWorld_uid=$(getuid)
    fi

    ##### get the gid and add the group if nessasary #####

    NewWorld_gid=$(getgid)
    if [ is_number $NewWorld_gid ]
    then
        ;;
    else
        mkgid
        addtogroup  $NewWorld_uid $NewWorld_gid
    fi

    # fixme we should test if its made
    ##### add the main folder fpor the product #####

    add_layers_folder "'weather'" $NewWorld_uid $NewWorld_gid "$name" "$fullname" "$description"


   
while read conf
do
    (mknewworld_ds "$conf")
done <<< "$configs"
